# 经验教训汇总

本文档记录项目开发过程中的重要经验教训，供后续开发参考。

---

## 2026-01-13: 字体优化与菜单清理

### 背景
尝试优化微信读书字体调整速度（从37秒优化到<1秒），最终接受现状并清理了菜单中不必要的按钮。

### 关键教训

#### 1. 性能优化：先理解架构瓶颈再动手

**问题**：
- 目标：将字体reload从37秒优化到<1秒
- 尝试方案A：CSS变量注入 → 失败
- 尝试方案B：双View轮换 → 实现但失败

**根本原因**：
- 微信读书是React SPA架构
- React组件只在mount时读取localStorage
- 修改localStorage不会触发重新渲染
- **`location.reload()` 是唯一可靠方法**

**瓶颈分析**：
```
reload时间分布：
- 资源下载（10秒）：可通过缓存优化 ✓
- JS执行（27秒）：CPU密集，无法优化 ✗
- DOM构建（2秒）：无法优化 ✗
```

**元规则**：
> ⚠️ **在尝试性能优化前，必须先分析性能瓶颈**
> 1. 测量各阶段耗时
> 2. 识别不可优化的部分（如第三方架构限制）
> 3. 只优化可控部分
> 4. 接受不可逾越的限制

#### 2. 双View方案失败的原因

**实现思路**：
- 维护两个QWebEngineView（主View + 后台View）
- 后台View加载新字体（30秒）
- 完成后swap指针 → 用户感知<1秒

**失败原因**：
- 两个View共享同一个QWebEngineProfile
- localStorage在profile级别共享
- 后台View修改localStorage后，主View也能看到变化
- 但主View不会重新渲染，导致状态不一致

**备选方案被否决**：
- 独立profile → 登录状态丢失，用户体验差
- 内存开销：+200MB（reMarkable只有512MB）

**元规则**：
> ⚠️ **复杂方案实施前，必须验证关键假设**
> 1. 双View共享profile → localStorage会冲突吗？ ✗（未验证）
> 2. 独立profile → 登录状态如何处理？ ✗（未考虑）
> 3. 内存开销是否可接受？ ✗（未评估）
> 
> **应该做的**：先写POC验证，再全面实施

#### 3. 功能删除的完整性检查清单

**任务**：删除菜单中的"字体切换"和"UA"按钮

**容易遗漏的地方**（实际遇到）：
- ✓ UI按钮创建代码（init_startup.cpp）
- ✓ 成员变量（m_uaButton）
- ✗ 函数实现（updateUaButtonText） → 编译失败
- ✗ 函数声明（.h文件） → 编译失败
- ✗ 所有调用点（part3.cpp, part5.cpp） → 编译失败

**元规则**：
> ⚠️ **删除功能时使用检查清单**
> 1. grep搜索所有相关符号（变量名、函数名）
> 2. 按顺序删除：
>    - UI创建代码
>    - 成员变量
>    - 函数实现
>    - 函数声明
>    - 所有调用点
> 3. 编译验证（每删一部分就编译）
> 4. 提交前再次grep确认无残留

#### 4. 部署到运行中设备的正确姿势

**错误做法**（本次犯的错误）：
```bash
# ❌ 直接scp覆盖运行中的二进制
scp binary root@device:/path/to/app
# 结果：命令卡死，文件无法覆盖
```

**正确做法**：
```bash
# ✓ 方案1：上传到临时位置
scp binary root@device:/tmp/app.new
ssh root@device "cp /tmp/app.new /path/to/app"

# ✓ 方案2：验证时间戳
ssh root@device "stat -c '%Y' /path/to/app"  # 验证是否真的替换了
```

**元规则**：
> ⚠️ **部署到运行中的设备**
> 1. 永远先上传到/tmp
> 2. 用cp强制覆盖（即使文件被占用）
> 3. 检查时间戳确认替换成功
> 4. 提示用户重启应用

#### 5. 方案选择：简单 > 复杂

**本次案例**：
- 方案A（CSS变量）：简单，但失败
- 方案B（双View）：复杂，实现了但失败
- 最终方案：接受现状（30-35秒） + 100MB缓存优化

**对比**：
| 方案 | 代码复杂度 | 可维护性 | 可靠性 | 结果 |
|------|----------|---------|--------|------|
| A: CSS | 低 | 高 | 0% | ❌ 失败 |
| B: 双View | 高 | 低 | 50% | ❌ 失败 |
| 接受现状 | 低 | 高 | 100% | ✅ 成功 |

**元规则**：
> ⚠️ **优先选择简单方案**
> 1. 简单方案失败 → 分析失败原因
> 2. 如果是架构限制 → 考虑接受现状
> 3. 复杂方案 → 先验证核心假设
> 4. **不要为了"完美"而过度工程化**

### 技术债务记录

以下功能仍然存在但未使用，可考虑未来清理：

1. **cycleUserAgentMode()** - UA切换功能
   - 按钮已删除，但函数仍保留
   - 涉及文件：weread_browser_part5.cpp
   - 建议：保留，可能有其他地方调用

2. **toggleTheme()** - 主题切换功能
   - "字体切换"按钮删除后，此功能无UI入口
   - 可能通过其他方式调用
   - 建议：验证是否还在使用

---

## 通用元规则总结

### 规则1: 分析优先于实现
- 先搞清楚问题的本质
- 再寻找可行的解决方案
- 最后才开始编码

### 规则2: 验证关键假设
- 复杂方案 → 写POC验证
- 性能优化 → 先测量瓶颈
- 架构设计 → 先验证可行性

### 规则3: 接受现实约束
- 第三方框架的限制通常无法绕过
- 有些性能问题是合理的等待时间
- 不要盲目追求"完美"

### 规则4: 删除要彻底
- 使用检查清单
- grep搜索残留
- 编译验证完整性

### 规则5: 简单即是美
- 简单方案失败 ≠ 需要复杂方案
- 可能意味着问题本身无解
- 或者现状已经是最优解

---

*本文档持续更新，记录项目中的经验教训*
